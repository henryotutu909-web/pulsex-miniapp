<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PulseX Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      background:#0f172a;
      color:white;
      font-family:Arial;
      margin:0;
      padding:0;
    }
    .card {
      padding:20px;
      max-width:420px;
      margin:auto;
    }
    button {
      width:100%;
      padding:14px;
      margin-top:10px;
      border:none;
      border-radius:10px;
      font-size:16px;
      cursor:pointer;
    }
    .green { background:#22c55e; color:black; }
    .blue { background:#3b82f6; color:white; }
    .box {
      background:#020617;
      padding:14px;
      border-radius:12px;
      margin-top:14px;
    }
  </style>
</head>

<body>

<div class="card">
  <h2>ğŸ”¥ PulseX</h2>

  <div class="box">
    <b>Points:</b> <span id="points">0</span><br>
    <b>Referrals:</b> <span id="refs">0</span>
  </div>

  <button id="claimBtn" class="green">CLAIM</button>
  <div id="status"></div>

  <div class="box">
    <h3>ğŸ¤ Referral</h3>
    <input id="refLink" readonly style="width:100%;padding:8px;border-radius:6px;">
    <button id="copyBtn" class="blue">Copy Link</button>
  </div>

  <div class="box">
    <h3>ğŸ† Leaderboard</h3>
    <div id="leaderboard">Loading...</div>
  </div>

  <div class="box">
    <h3>ğŸª‚ Airdrop</h3>
    <p>Coming soon. Early users will be prioritized.</p>
  </div>
</div>

<script>
const BACKEND = "https://pulsex-backend-iqcp.onrender.com";
const statusEl = document.getElementById("status");
const pointsEl = document.getElementById("points");
const refsEl = document.getElementById("refs");

function userId() {
  return Telegram.WebApp?.initDataUnsafe?.user?.id || null;
}

Telegram.WebApp.ready();
Telegram.WebApp.expand();

const uid = userId();
document.getElementById("refLink").value =
  uid ? `https://t.me/pulsex_airdrop_bot?start=${uid}` : "";

document.getElementById("copyBtn").onclick = () => {
  document.getElementById("refLink").select();
  document.execCommand("copy");
  statusEl.innerText = "âœ… Link copied";
};

// ---------- CLAIM ----------
document.getElementById("claimBtn").onclick = async () => {
  statusEl.innerText = "â³ Claiming...";
  const r = await fetch(`${BACKEND}/claim`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ user_id: uid })
  });
  const d = await r.json();
  if (d.success) statusEl.innerText = "âœ… Claimed +100";
  else if (d.remaining) statusEl.innerText = "â³ Cooldown active";
  loadMe();
};

// ---------- LOAD USER ----------
async function loadMe() {
  const r = await fetch(`${BACKEND}/me`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ user_id: uid })
  });
  const d = await r.json();
  pointsEl.innerText = d.points;
  refsEl.innerText = d.referrals;
}

// ---------- LEADERBOARD ----------
async function loadLeaderboard() {
  const r = await fetch(`${BACKEND}/leaderboard`);
  const d = await r.json();
  document.getElementById("leaderboard").innerHTML =
    d.map(x => `${x.rank}. ${x.username} â€” ${x.points}`).join("<br>");
}

loadMe();
loadLeaderboard();
</script>

</body>
</html>
