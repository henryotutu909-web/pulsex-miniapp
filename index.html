<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PulseX Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      background:#0f172a;
      color:white;
      font-family:Arial, sans-serif;
      margin:0;
      padding:0;
    }
    .card {
      padding:20px;
      max-width:420px;
      margin:auto;
    }
    .box {
      background:#020617;
      padding:14px;
      border-radius:12px;
      margin-top:14px;
    }
    button {
      width:100%;
      padding:14px;
      margin-top:10px;
      border:none;
      border-radius:10px;
      font-size:16px;
      cursor:pointer;
    }
    .green { background:#22c55e; color:black; }
    .blue { background:#3b82f6; color:white; }
    input {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:none;
      margin-top:8px;
      font-size:13px;
    }
    #status {
      margin-top:10px;
      font-size:14px;
      opacity:0.9;
    }
  </style>
</head>

<body>

<div class="card">
  <h2>üî• PulseX</h2>

  <!-- USER STATS -->
  <div class="box">
    <b>Points:</b> <span id="points">0</span><br>
    <b>Referrals:</b> <span id="refs">0</span>
  </div>

  <!-- CLAIM -->
  <button id="claimBtn" class="green">CLAIM</button>
  <div id="status">Waiting...</div>

  <!-- REFERRAL -->
  <div class="box">
    <h3>ü§ù Invite Friends</h3>
    <p style="font-size:13px;opacity:0.8;">
      Earn more points when friends join using your link.
    </p>
    <input id="refLink" readonly />
    <button id="copyBtn" class="blue">Copy Referral Link</button>
  </div>

  <!-- LEADERBOARD -->
  <div class="box">
    <h3>üèÜ Leaderboard</h3>
    <div id="leaderboard">Loading...</div>
  </div>

  <!-- AIRDROP -->
  <div class="box">
    <h3>ü™Ç Airdrop</h3>
    <p>Coming soon. Early users will be prioritized.</p>
  </div>
</div>

<script>
  const BACKEND = "https://pulsex-backend-iqcp.onrender.com";

  const statusEl = document.getElementById("status");
  const pointsEl = document.getElementById("points");
  const refsEl = document.getElementById("refs");
  const claimBtn = document.getElementById("claimBtn");
  const refInput = document.getElementById("refLink");
  const copyBtn = document.getElementById("copyBtn");

  // Telegram init
  if (window.Telegram && Telegram.WebApp) {
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
  }

  function getUserId() {
    return Telegram.WebApp?.initDataUnsafe?.user?.id || null;
  }

  function getReferrerId() {
    return Telegram.WebApp?.initDataUnsafe?.start_param || null;
  }

  const userId = getUserId();
  const referrerId = getReferrerId();

  // Generate referral link
  if (userId) {
    refInput.value = `https://t.me/YOUR_BOT_USERNAME?start=${userId}`;
  } else {
    refInput.value = "Open app via Telegram bot";
  }

  copyBtn.onclick = () => {
    refInput.select();
    document.execCommand("copy");
    statusEl.innerText = "‚úÖ Referral link copied";
  };

  // CLAIM
  claimBtn.onclick = async () => {
    if (!userId) {
      statusEl.innerText = "‚ö†Ô∏è Open this app from Telegram";
      return;
    }

    statusEl.innerText = "‚è≥ Claiming...";

    try {
      const res = await fetch(`${BACKEND}/claim`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: userId,
          referrer_id: referrerId
        })
      });

      const data = await res.json();

      if (data.success) {
        statusEl.innerText = "‚úÖ Claimed +100 points";
      } else if (data.remaining) {
        const hrs = Math.ceil(data.remaining / 3600);
        statusEl.innerText = `‚è≥ Come back in ${hrs}h`;
      } else if (data.error) {
        statusEl.innerText = `‚ùå ${data.error}`;
      } else {
        statusEl.innerText = "‚ùå Claim failed";
      }

      loadMe();
      loadLeaderboard();

    } catch (e) {
      statusEl.innerText = "‚ùå Network error";
    }
  };

  // LOAD USER DATA
  async function loadMe() {
    if (!userId) return;
    const res = await fetch(`${BACKEND}/me`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: userId })
    });
    const data = await res.json();
    pointsEl.innerText = data.points ?? 0;
    refsEl.innerText = data.referrals ?? 0;
  }

  // LEADERBOARD
  async function loadLeaderboard() {
    const res = await fetch(`${BACKEND}/leaderboard`);
    const data = await res.json();
    document.getElementById("leaderboard").innerHTML =
      data.map(x => `${x.rank}. ${x.user} ‚Äî ${x.points}`).join("<br>");
  }

  loadMe();
  loadLeaderboard();
</script>

</body>
</html>
